<script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
	import HourlyWeatherSummary from './HourlyWeatherSummary.js'
	import DailyWeatherSummary from './DailyWeatherSummary.js'
	import AirQualitySummary from './AirQualitySummary.js'
	import Packing from './Packing.js';

    createApp({
		components: {
			HourlyWeatherSummary,
			DailyWeatherSummary,
			AirQualitySummary,
			Packing,
		},
        data() {
            return {
                city: "",
				weather: {},
				processedWeather: [],
				displayWeather: false,
				fourDayAverage: 0, 		// Average temperature over the next four days
				willRain: false,			// Whether it is predicted to rain in the next four days
				lat: 0.00,				// Latitude for inputted city
				lon: 0.00,				// Longitude for inputted city
				airPollution: {},		// Air pollution data for inputted city
				averageAirQuality: 0,	// Average air quality over the next four days
				maskRecommended: false,	// Whether a mask is recommended based on the air quality
				innovativeFeature: {}
            }
        },
        methods: {
			GetData: getData,
			GetWeather: getWeather,
			GetAirPollution: getAirPollution,
			ProcessData: processData,
			ShowAirQualityGraph: showAirQualityGraph,
			GetInnovativeFeature: getInnovativeFeature
        }
    }).mount('#app')

	async function getData() {
		await this.GetWeather();
		// Don't call getAirPollution until getWeather has finished
		await this.GetAirPollution();
		this.ProcessData();
	}

	async function getWeather(processData) {
		console.log("getWeather called");
		let promise = fetch("weather/" + this.city);
		let response = await promise;
		let json = await response.json();
		this.weather = json;

		console.log(this.weather);

		// Get latitude and longitude for inputted city
		this.lat = this.weather.city.coord.lat;
		this.lon = this.weather.city.coord.lon;

		console.log("lat: " + this.lat);
		console.log("lon: " + this.lon);
	}

	async function getAirPollution() {
		console.log("getAirPollution called");
		let promise = fetch("airpollution/" + this.lat + "/" + this.lon);
		let response = await promise;
		let json = await response.json();
		this.airPollution = json;

		console.log(this.airPollution);
	}

	function processData() {
		let numberOfDays = 5;

		console.log("processData called")

		// processedWeather: [
		// 	{
		//		averageRain: 0,
		//		averageTemp: 0,
		//		averageWind: 0,
		// 		date: YYYY-MM-DD,
		// 		list: [
		// 		]
		// 	},
		// ]

		let currentDate = new Date()

		for (let i = 0; i < numberOfDays; i++) {
			this.processedWeather[i] = {
				date: currentDate.toJSON().slice(0,10),
				list: []
			};
			currentDate.setDate(currentDate.getDate() + 1);

			for (let j = 0; j < this.weather.list.length; j++) {
				if (this.weather.list[j].dt_txt.slice(0,10) == this.processedWeather[i].date) {
					this.processedWeather[i].list.push(this.weather.list[j])
				}
			}
		}

		// Calculate average temperature, wind speed, and rainfall for each day
		for (let i = 0; i < this.processedWeather.length; i++) {
			let totalTemp = 0;
			let totalWind = 0;
			let totalRain = 0;

			for (let j = 0; j < this.processedWeather[i].list.length; j++) {
				totalTemp += this.processedWeather[i].list[j].main.temp;
				totalWind += this.processedWeather[i].list[j].wind.speed;
				if (this.processedWeather[i].list[j].hasOwnProperty("rain")) {
				 	totalRain += this.processedWeather[i].list[j].rain["3h"];
 				}
			}

			console.log(totalRain);
			this.processedWeather[i].averageTemp = totalTemp / this.processedWeather[i].list.length;
			this.processedWeather[i].averageWind = totalWind / this.processedWeather[i].list.length;
			this.processedWeather[i].averageRain = totalRain / this.processedWeather[i].list.length;
		}

		// Calculate average temperature over the next four days
		let totalTemp = 0;
		for (let i = 0; i < this.processedWeather.length; i++) {
			totalTemp += this.processedWeather[i].averageTemp;
		}
		this.fourDayAverage = totalTemp / this.processedWeather.length;

		// Calculate whether it is predicted to rain in the next four days
		for (let i = 0; i < this.processedWeather.length; i++) {
			if (this.processedWeather[i].averageRain > 0) {
				this.willRain = true;
				break;
			}
		}

		console.log(this.processedWeather);
		console.log("Four Day Average: " + this.fourDayAverage);
		console.log("Rain: " + this.willRain);
		this.displayWeather = true;

		let totalPm2_5 = 0;
		// Get average pm2_5 for the next 5 days
		for (let i = 0; i < this.airPollution.list.length; i++) {
			totalPm2_5 += this.airPollution.list[i].components.pm2_5;
			if (this.airPollution.list[i].components.pm2_5 > 10) {
				this.maskRecommended = true;
			}
		}
		this.averageAirQuality = totalPm2_5 / this.airPollution.list.length;
		console.log("Average Air Quality (PM_2.5): " + this.averageAirQuality);
	}

	function showAirQualityGraph() {
		console.log("showAirQualityGraph called")

		let date = new Date(1665925200*1000);
		console.log(date.toJSON());

		let xArray = [];
		let yArray = [];

		for (let i = 0; i < this.airPollution.list.length; i++) {
			let date = new Date(this.airPollution.list[i].dt*1000);
			xArray.push(date.toJSON());
			yArray.push(this.airPollution.list[i].components.pm2_5);
		}

		// Define Data
		let data = [{
			x: xArray,
			y: yArray,
			mode:"lines",
			line: {
				color: "#827397",
			}
		}];

		// Define Layout
		var layout = {
			xaxis: {title: "Date"},
			yaxis: {title: "Ð¡oncentration of PM_2.5, Î¼g/m3"},  
			title: "Air Quality"
		};

		// Display using Plotly
		Plotly.newPlot("air-quality-graph", data, layout);
	}

	async function getInnovativeFeature() {
		console.log("getInnovativeFeature");
		let promise = fetch("innovative/" + this.city);
		let response = await promise;
		let json = await response.json();
		this.innovativeFeature = json;

		console.log(this.innovativeFeature);
	}

</script>

<!DOCTYPE html>
	<head>
		<title>Weather App</title>
		<link rel="stylesheet" href="./style.css">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
	</head>
	<body>
		<div id="app">
			<div class="main"> 
				<h1>ðŸŒ¤ Weather App ðŸŒ¤</h1>
				<p>Simply enter the city you are planning to visit and get the weather and air pollution forecast for the next few days. From this we'll recommend what you should pack.</p>
				
				<input v-model="city" class="form-control" type="text" placeholder="Destination city">
				<button v-on:click="GetData(ProcessData)" class="btn btn-dark m-3">Submit</button>

				<div v-if="displayWeather" class="m-4">	
					<daily-weather-summary :processed-weather="processedWeather"></daily-weather-summary>
					
					<br>
					<br>

					<packing :four-day-average="fourDayAverage" :will-rain="willRain"></packing>
	
					<br>
					<br>

					<air-quality-summary :average-air-quality="averageAirQuality" :mask-recommended="maskRecommended"></air-quality-summary>
					<button v-on:click="ShowAirQualityGraph" class="btn btn-dark">Show Graph of Air Quality</button>
					<div id="air-quality-graph"></div>
	
				</div>	
			</div>

			<div class="innovative-feature">
				<h1>Innovative Feature</h1>
				<button v-on:click="GetInnovativeFeature" class="btn btn-dark m-3">Submit</button>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.min.js" integrity="sha384-IDwe1+LCz02ROU9k972gdyvl+AESN10+x7tBKgc9I5HFtuNz0wWnPclzo6p9vxnk" crossorigin="anonymous"></script>
		<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	</body>
</html>