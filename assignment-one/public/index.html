<script type="module">
	// Add to separate .vue file
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
	import WeatherSummary from './WeatherSummary.js'
	import Packing from './Packing.js'

    createApp({
		components: {
			WeatherSummary,
			Packing
		},
        data() {
            return {
                city: "",
				weather: {},
				processedWeather: [],
				displayWeather: false,
				fourDayAverage: 0, 		// Average temperature over the next four days
				rain: false				// Whether it is predicted to rain in the next four days
            }
        },
        methods: {
			GetWeather: getWeather,
			ProcessData: processData
        }
    }).mount('#app')

	async function getWeather(processData) {
		console.log("getWeather called")
		let promise = fetch("weather/" + this.city)
		let response = await promise
		let json = await response.json()
		this.weather = json

		processData();
	}

	function processData() {
		let numberOfDays = 5;

		console.log("processData called")

		// processedWeather: [
		// 	{
		//		averageRain: 0,
		//		averageTemp: 0,
		//		averageWind: 0,
		// 		date: YYYY-MM-DD,
		// 		list: [
		// 		]
		// 	},
		// 	{
		//		averageRain: 0,
		//		averageTemp: 0,
		//		averageWind: 0,
		// 		date: YYYY-MM-DD,
		// 		list: [
		// 		]
		// 	}
		// ]

		let currentDate = new Date()

		for (let i = 0; i < numberOfDays; i++) {
			this.processedWeather[i] = {
				date: currentDate.toJSON().slice(0,10),
				list: []
			};
			currentDate.setDate(currentDate.getDate() + 1);

			for (let j = 0; j < this.weather.list.length; j++) {
				if (this.weather.list[j].dt_txt.slice(0,10) == this.processedWeather[i].date) {
					this.processedWeather[i].list.push(this.weather.list[j])
				}
			}
		}

		// Calculate average temperature, wind speed, and rainfall for each day
		for (let i = 0; i < this.processedWeather.length; i++) {
			let totalTemp = 0;
			let totalWind = 0;
			let totalRain = 0;

			for (let j = 0; j < this.processedWeather[i].list.length; j++) {
				totalTemp += this.processedWeather[i].list[j].main.temp;
				totalWind += this.processedWeather[i].list[j].wind.speed;
				// totalRain += this.processedWeather[i].list[j].rain["3h"];
			}

			this.processedWeather[i].averageTemp = totalTemp / this.processedWeather[i].list.length;
			this.processedWeather[i].averageWind = totalWind / this.processedWeather[i].list.length;
			this.processedWeather[i].averageRain = totalRain / this.processedWeather[i].list.length;
		}

		// Calculate average temperature over the next four days
		let totalTemp = 0;
		for (let i = 0; i < this.processedWeather.length; i++) {
			totalTemp += this.processedWeather[i].averageTemp;
		}
		this.fourDayAverage = totalTemp / this.processedWeather.length;

		// Calculate whether it is predicted to rain in the next four days
		for (let i = 0; i < this.processedWeather.length; i++) {
			if (this.processedWeather[i].averageRain > 0) {
				this.rain = true;
				break;
			}
		}

		console.log(this.weather);	
		console.log(this.processedWeather);
		console.log(this.fourDayAverage);
		console.log(this.rain);
		this.displayWeather = true;
	}

</script>

<!DOCTYPE html>
	<head>
		<title>Weather App</title>
	</head>
	<body>
		<div id="app">
			<h1>Weather App</h1>
			<label>City Name</label>
			<input type="text" v-model="city">
			<br>

			<!-- Add error handling for if city isn't inputted or is invalid -->
			<button v-on:click="GetWeather(ProcessData)">Get Weather</button>
			
			<div v-if="displayWeather">	
				<h2>Packing</h2>
				<packing :four-day-average="fourDayAverage" :rain="rain"></packing>

				<h2>Weather Summary Table</h2>
				<weather-summary v-for="day in processedWeather" v-bind="day"></weather-summary>
			</div>	
		</div>
	</body>
</html>